{% extends 'base.html' %}
{% block title %}Database Search{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <style>
    .filter-container { background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
    .filter-row { display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap; }
    .filter-group { flex: 1; min-width: 200px; }
    .filter-group label { display: block; font-weight: bold; margin-bottom: 5px; }
    .filter-group input, .filter-group select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    .btn-group { margin-top: 10px; }
    .column-toggle { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .column-toggle-header { font-weight: bold; margin-bottom: 10px; cursor: pointer; }
    .column-toggle-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px; max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
    .column-toggle-content.show { max-height: 500px; overflow-y: auto; }
    .column-checkbox { display: flex; align-items: center; gap: 5px; }
    .model-selector { background: #e9ecef; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    .model-selector label { font-weight: bold; margin-right: 10px; }
  </style>
</head>
<body>
  <h1>Database Search</h1>

  <!-- Model Selector -->
  <div class="model-selector">
    <label for="modelSelect">Select Data Type:</label>
    <select id="modelSelect" class="form-control" style="width: auto; display: inline-block;">
      <option value="pathogen">Pathogen</option>
      <option value="host">Host</option>
      <option value="sequence">Sequence</option>
      <option value="descriptive">Descriptive</option>
      <option value="fulltext">Full Text</option>
    </select>
    <span style="margin-left: 15px; color: #666;">Search and filter across different data types in the database</span>
  </div>

  <!-- Advanced Filters -->
  <div class="filter-container">
    <h4>Filters</h4>
    <div class="filter-row" id="dynamicFilters">
      <!-- Filters will be dynamically inserted based on model selection -->
    </div>
    <div class="btn-group">
      <button id="applyFilters" class="btn btn-primary">Apply Filters</button>
      <button id="clearFilters" class="btn btn-secondary">Clear Filters</button>
      <button id="exportData" class="btn btn-success">Export to CSV</button>
    </div>
  </div>

  <!-- Column Visibility Toggle -->
  <div class="column-toggle">
    <div class="column-toggle-header" id="toggleColumnsBtn">▶ Show/Hide Columns</div>
    <div class="column-toggle-content" id="columnToggles"><!-- populated by JS --></div>
  </div>

  <!-- DataTable -->
  <table id="unifiedTable" class="display" style="width:100%">
    <thead>
      <tr><!-- header built by JS --></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
  $(document).ready(function() {
    let table = null;
    let allColumns = [];
    let currentModel = 'pathogen';
    let currentFilters = [];

    // Define default visible columns for each model
    const defaultColumns = {
      pathogen: ['id', 'family', 'scientific_name', 'assay', 'tested', 'positive', 'host__scientific_name', 'host__country'],
      host: ['id', 'scientific_name', 'country', 'locality', 'individual_count', 'event_date'],
      sequence: ['id', 'scientific_name', 'accession_number', 'sequence_type', 'date_sampled'],
      descriptive: ['id', 'dataset_name', 'sampling_effort', 'data_access', 'full_text__title'],
      fulltext: ['id', 'title', 'author', 'publication_year', 'decision']
    };

    function loadFilters(callback) {
      $.ajax({
        url: '/api/unified/filters/',
        data: { model: currentModel },
        success: function(resp) {
          currentFilters = resp.filters || [];
          if (callback) callback();
        },
        error: function(xhr, status, error) {
          console.error('Failed to load filters:', error);
          // Show user-visible error message
          $('#dynamicFilters').html(
            '<div class="alert alert-warning" role="alert">' +
            '<strong>Warning:</strong> Could not load filters. Please refresh the page or try again later.' +
            '</div>'
          );
          currentFilters = [];
          if (callback) callback();
        }
      });
    }

    function renderFilters() {
      if (!currentFilters || currentFilters.length === 0) {
        $('#dynamicFilters').html('<div style="padding: 10px; color: #666;">Loading filters...</div>');
        return;
      }

      // Limit to most relevant fields (avoid overwhelming UI)
      const MAX_VISIBLE_FILTERS = 8;
      const relevantFilters = currentFilters.filter(f => {
        // Include only top-level fields and first-level related fields
        const depth = (f.name.match(/__/g) || []).length;
        if (depth > 1) return false;

        // Exclude model ID fields (id, pk, original_id, and related *_id/*__id/*__pk)
        const name = (f.name || '').toLowerCase();
        const isIdField = (
          name.endsWith('_id') ||
          name.endsWith('_pk') ||
          name.endsWith('_original_id')
        );
        return !isIdField;
      }).slice(0, MAX_VISIBLE_FILTERS);

      const html = relevantFilters.map(f => {
        const id = 'filter_' + f.name.replace(/[^a-zA-Z0-9]/g, '_');
        
        if (f.filter_type === 'range') {
          // Create two inputs for range filters (from/to)
          return `
            <div class="filter-group">
              <label for="${id}_from">${f.label} (From)</label>
              <input type="${f.type}" id="${id}_from" placeholder="Min" data-param="${f.name}_from">
            </div>
            <div class="filter-group">
              <label for="${id}_to">${f.label} (To)</label>
              <input type="${f.type}" id="${id}_to" placeholder="Max" data-param="${f.name}_to">
            </div>
          `;
        } else if (f.type === 'boolean') {
          // Create a select for boolean filters
          return `
            <div class="filter-group">
              <label for="${id}">${f.label}</label>
              <select id="${id}" data-param="${f.name}">
                <option value="">All</option>
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </div>
          `;
        } else {
          // Create standard text input
          return `
            <div class="filter-group">
              <label for="${id}">${f.label}</label>
              <input type="${f.type}" id="${id}" placeholder="Enter ${f.label.toLowerCase()}" data-param="${f.name}">
            </div>
          `;
        }
      }).join('');
      
      $('#dynamicFilters').html(html || '<div style="padding: 10px; color: #666;">No filters available</div>');
    }

    function getActiveFilters() {
      const params = { model: currentModel };
      if (table) {
        const searchValue = table.search(); 
        if (searchValue) params.search = searchValue;
        const order = table.order(); 
        if (order && order.length > 0) {
          const orderColumnIndex = order[0][0]; 
          const orderDir = order[0][1];
          const columnData = table.settings()[0].aoColumns[orderColumnIndex].data;
          params.ordering = (orderDir === 'asc' ? '' : '-') + columnData;
        }
      }
      
      // Get dynamic filter values
      $('#dynamicFilters input, #dynamicFilters select').each(function() {
        const val = $(this).val();
        const param = $(this).data('param');
        if (val && param) {
          params[param] = val;
        }
      });
      
      return params;
    }

    function getStorageKey(key) {
      return `${currentModel}_${key}`;
    }

    function initializeTable() {
      const saved = localStorage.getItem(getStorageKey('visibleColumns'));
      const visibleColumns = saved ? JSON.parse(saved) : (defaultColumns[currentModel] || []);
      console.debug('[initializeTable] visibleColumns=', visibleColumns, 'allColumns=', allColumns.length);

      const columnsConfig = allColumns.map(col => ({
        data: col.data, 
        title: col.title, 
        defaultContent: '-', 
        orderable: true,
        visible: visibleColumns.includes(col.data),
        render: function(data, type, row) {
          try {
            // Create links for ID fields
            if (col.data === 'id') {
              const idVal = row['id'];
              if (idVal) {
                return '<a href="/' + currentModel + '/' + idVal + '/">' + (data || '') + '</a>';
              }
            }
            // Handle nested object links
            if (col.data.includes('__') && (col.data.endsWith('__id') || col.data.endsWith('__pk'))) {
              const idVal = data;
              if (idVal) {
                const parts = col.data.split('__');
                const modelName = parts[parts.length - 2];
                return '<a href="/' + modelName + '/' + idVal + '/">' + idVal + '</a>';
              }
            }
            // Handle title links
            if (col.data.includes('full_text__title')) {
              const ft_id = row['full_text__id'] || row['full_text__pk'] || '';
              if (ft_id) return '<a href="/fulltext/' + ft_id + '/">' + (data || '') + '</a>';
            }
          } catch (e) { 
            console.error('render error for column', col, e); 
          }
          return data;
        }
      }));

      if (table) { 
        try { 
          table.destroy(); 
        } catch (e) { 
          console.warn('destroy err', e); 
        } 
        $('#unifiedTable').empty(); 
      }

      const headerHtml = allColumns.map(c => '<th>' + c.title + '</th>').join('');
      $('#unifiedTable').html('<thead><tr>' + headerHtml + '</tr></thead><tbody></tbody>');

      try {
        console.debug('[initializeTable] creating DataTable with', columnsConfig.length, 'columns');
        table = $('#unifiedTable').DataTable({
          destroy: true,
          ajax: {
            url: '/api/unified/',
            data: function(d) {
              console.debug('[DataTable ajax.data] params', d);
              const params = { 
                limit: d.length, 
                offset: d.start,
                model: currentModel
              };
              if (d.search && d.search.value) params.search = d.search.value;
              if (d.order && d.order.length > 0) { 
                const orderColumn = d.columns[d.order[0].column]; 
                const orderDir = d.order[0].dir === 'asc' ? '' : '-'; 
                params.ordering = orderDir + orderColumn.data; 
              }
              const extra = getActiveFilters(); 
              Object.assign(params, extra);
              return params;
            },
            dataSrc: function(json) { 
              console.debug('[DataTable dataSrc] got', json); 
              if (!json || !json.results) { 
                console.error('Invalid response', json); 
                return []; 
              } 
              json.recordsTotal = json.count || 0; 
              json.recordsFiltered = json.count || 0; 
              return json.results; 
            },
            error: function(xhr, error, code) { 
              console.error('DataTables Ajax error', error, code, xhr && xhr.responseText); 
            }
          },
          columns: columnsConfig,
          processing: true,
          serverSide: true,
          paging: true,
          searching: true,
          ordering: true,
          pageLength: 100,
          scrollX: true,
          deferRender: true,
          searchDelay: 500,
          stateSave: false
        });
      } catch (err) { 
        console.error('DataTable init error', err); 
      }
    }

    function populateColumnToggles() {
      const saved = localStorage.getItem(getStorageKey('visibleColumns'));
      const visibleColumns = saved ? JSON.parse(saved) : (defaultColumns[currentModel] || []);
      const togglesHtml = allColumns.map(col => 
        '<div class="column-checkbox">' + 
        '<input type="checkbox" id="col_' + col.data.replace(/[^a-zA-Z0-9]/g, '_') + '" value="' + col.data + '"' + 
        (visibleColumns.includes(col.data) ? ' checked' : '') + '>' + 
        '<label for="col_' + col.data.replace(/[^a-zA-Z0-9]/g, '_') + '">' + col.title + '</label>' +
        '</div>'
      ).join('');
      $('#columnToggles').html(togglesHtml);

      $('#columnToggles').off('change', 'input[type="checkbox"]').on('change', 'input[type="checkbox"]', function() {
        const checked = $('#columnToggles input[type="checkbox"]:checked').map(function() { 
          return $(this).val(); 
        }).get();
        if (checked.length === 0) { 
          alert('Please select at least one column'); 
          $(this).prop('checked', true); 
          return; 
        }
        localStorage.setItem(getStorageKey('visibleColumns'), JSON.stringify(checked));
        if (table) {
          const toggled = $(this).val(); 
          const colIndex = allColumns.findIndex(c => c.data === toggled);
          if (colIndex >= 0) { 
            const show = $(this).is(':checked'); 
            try { 
              table.column(colIndex).visible(show, false); 
              table.columns.adjust().draw(false); 
            } catch (e) { 
              console.error('toggle visible err', e); 
              initializeTable(); 
            }
          } else { 
            initializeTable(); 
          }
        } else { 
          initializeTable(); 
        }
      });
    }

    function loadColumns() {
      $.ajax({ 
        url: '/api/unified/columns/', 
        data: { model: currentModel },
        success: function(resp) { 
          allColumns = resp.columns || []; 
          initializeTable(); 
          populateColumnToggles(); 
        }, 
        error: function(xhr, status, error) { 
          console.error('Failed to load columns:', error);
          // Show user-visible error message
          alert('Warning: Could not load table columns. Using minimal fallback. Please refresh the page.');
          allColumns = [{data:'id',title:'ID'}]; 
          initializeTable(); 
          populateColumnToggles(); 
        } 
      });
    }

    // Initialize with default model
    loadFilters(function() {
      renderFilters();
      loadColumns();
    });

    // Model selector change handler
    $('#modelSelect').change(function() {
      currentModel = $(this).val();
      loadFilters(function() {
        renderFilters();
        loadColumns();
      });
    });

    $('#toggleColumnsBtn').click(function() { 
      $('#columnToggles').toggleClass('show'); 
      $(this).text($(this).text().includes('▶') ? '▼ Show/Hide Columns' : '▶ Show/Hide Columns'); 
    });
    
    $('#applyFilters').click(function() { 
      if (table) table.ajax.reload(null, false); 
    });
    
    $('#clearFilters').click(function() { 
      $('#dynamicFilters input, #dynamicFilters select').val(''); 
      if (table) { 
        table.search('').draw(); 
      } 
    });
    
    $('#exportData').click(function() { 
      const filters = getActiveFilters(); 
      const saved = localStorage.getItem(getStorageKey('visibleColumns')); 
      const visibleColumns = saved ? JSON.parse(saved) : (defaultColumns[currentModel] || []); 
      const params = new URLSearchParams(); 
      for (const [k,v] of Object.entries(filters)) {
        if (v) params.append(k,v); 
      }
      if (visibleColumns && visibleColumns.length) {
        params.append('columns', visibleColumns.join(',')); 
      }
      const orig = $(this).text(); 
      $(this).text('Exporting...').prop('disabled',true); 
      window.location.href = '/api/unified/export/?' + params.toString(); 
      setTimeout(()=>$(this).text(orig).prop('disabled',false),2000); 
    });
    
    $('#dynamicFilters').on('keypress', 'input', function(e){ 
      if (e.which===13) $('#applyFilters').click(); 
    });
  });
  </script>
</body>
</html>
{% endblock %}